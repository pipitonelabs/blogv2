---
import { cn } from '../../utils'

const { class: className } = Astro.props
---

<quote-component class={cn('not-prose inline-block', className)}>
  <div class='flex rounded-lg border px-4 py-3 text-sm shadow-sm'>
    <span class='relative flex items-start justify-center mt-0.5 mr-3 flex-shrink-0'>
      <span
        class='absolute size-2 animate-ping rounded-full border border-green-400 bg-green-400 opacity-75'
      ></span>
      <span class='size-2 rounded-full bg-green-400'></span>
    </span>
    <p id='quote-sentence' class='font-medium text-muted-foreground leading-relaxed break-words whitespace-pre-wrap'>Loading...</p>
  </div>
</quote-component>

<script>
  import config from 'virtual:config'

  const { quote } = config.integ

  class Quote extends HTMLElement {
    constructor() {
      super()
    }

    render(sentence: string) {
      const quoteEl = this.querySelector('#quote-sentence') as HTMLElement
      if (!quoteEl) return
      quoteEl.innerText = sentence
    }

    connectedCallback() {
      // Because virtual:config can only be accessed using json string, function cannot work, so we need to use new Function
      const targetFunction = new Function('data', 'return (' + quote.target + ')(data)')
      fetch(quote.server)
        .then((response) => response.json())
        .then((data) => this.render(targetFunction(data)))
    }
  }
  customElements.define('quote-component', Quote)
</script>